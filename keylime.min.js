/*jshint laxbreak:true, boss:true, shadow:true, unused:true*/
!function(e,t){var i,o=t(e)
"function"==typeof define&&define.amd&&define(i=o),"object"==typeof exports&&(module.exports=i=o),e.keyLime=o}("undefined"!=typeof global?global:this,function(e){"use strict"
function t(){var e=document.createElement("input")
e.type="number"
try{return e.selectionStart=0,!0}catch(t){return!1}}function i(){y(document.activeElement)&&(clearTimeout(v),!R&&f("keylimeshow")&&(document.body.appendChild(S),R=!0))}function o(){clearTimeout(v),v=setTimeout(function(){R&&f("keylimehide")&&(document.body.removeChild(S),R=!1,b&&(b.classList.remove("lime-focus"),b=null),S.style.bottom&&(S.style.top="",S.style.bottom=""))})}function n(){var e="",t={row2:{before:'<li id="limeTab" class="lime-key lime-special-key lime-tab">Tab</li>',after:'<li id="limeBackspace" class="lime-key lime-special-key lime-backspace">⌫</li>'},row3:{before:'<li id="limeShift" class="lime-key lime-special-key lime-shift">↑</li>',after:'<li id="limeCaret" class="lime-key lime-special-key lime-caret">|↔</li>'}},i=P.verbatim.keys
e+=i.standard.map(function(e,o){var n=t["row"+o]
return'<menu class="lime-key-row">'+(n&&n.before||"")+e.map(function(e,t){return'<li class="lime-key" data-text="'+e+'" data-symbol="'+i.symbol[o][t]+'"></li>'}).join("")+(n&&n.after||"")+"</menu>"}).join(""),e+='<menu class="lime-key-row"><li id="limeSymbol" class="lime-key lime-special-key">★</li><li class="lime-key lime-http" data-text="http://"></li><li class="lime-key lime-wwwdot" data-text="www."></li><li class="lime-key lime-spacebar" data-text=" ">&nbsp;</li><li class="lime-key lime-dotcom" data-text=".com"></li><li id="limeReturn" class="lime-key lime-special-key lime-return">→</li></menu>',S.innerHTML=e}function l(e){e.classList.contains("lime-key")&&(b&&b.classList.remove("lime-focus"),b=e,b.classList.add("lime-focus"))}function a(e){var t
if(b){if("left"===e||"right"===e)t=b[("left"===e?"previous":"next")+"Sibling"],t||x||(t=b.parentNode[("left"===e?"last":"first")+"Child"])
else if(!x){var i=b.getBoundingClientRect(),o=b.offsetHeight,n=i.top+("down"===e?o:-o),r=L
L||(r=L=i.left+b.offsetWidth/2),t=document.elementFromPoint("left"===C?r-10:r+10,n),t.classList.contains("lime-key")||(t=document.elementFromPoint(r+10,n))}}else t=S.querySelector(".lime-key")
if(t.classList.contains("lime-key"))l(t),("left"===e||"right"===e)&&(L=b.getBoundingClientRect().left+b.offsetWidth/2,C=e)
else if(x){var i=b.getBoundingClientRect()
return d(),l(document.elementFromPoint(i.left,i.top)),L=i.left+b.offsetWidth/2,a(e)}}function r(){var e,t,i=b,o="toLocaleUpperCase"in String.prototype?"toLocaleUpperCase":"toUpperCase"
if(t=D[i.id.slice(4)])return t(i)
if(e=i.dataset[k?"symbol":"text"]||i.dataset.text){(h||w)&&(e=e[o]()),h&&(h=!1,S.classList.remove("shift-toggle"))
var n=document.activeElement
if(U||N.test(n.type)){var l=n.selectionStart
n.value=n.value.slice(0,l)+e+n.value.slice(n.selectionEnd),n.selectionStart=n.selectionEnd=l+e.length}else{var a,r,s,c=window.getSelection()
c.deleteFromDocument()
do a=String(c).length,c.modify("extend","backward","line")
while(String(c).length!==a)
r=String(c),c.deleteFromDocument()
do a=String(c).length,c.modify("extend","forward","line")
while(String(c).length!==a)
for(s=String(c),c.deleteFromDocument(),n.setAttribute("value",n.defaultValue),n.value=r+e+s,n.select(),c=window.getSelection(),c.collapseToEnd();a-- >0;)c.modify("move","backward","character")}g(n)}}function s(e){e.preventDefault(),e.stopPropagation()}function c(){var e,t=document.activeElement.form
t&&(B?e=new Event("submit",{bubbles:!0,cancelable:!0}):(e=document.createEvent("HTMLEvents"),e.initEvent("submit",!0,!0)),t.dispatchEvent(e)&&t.submit()),o()}function m(){var e,t,i,o,n,l=P.verbatim.diacritics[b&&b.dataset.text]
b&&l&&((e=S.querySelector(".lime-diacritics-row"))||(e=document.createElement("menu"),e.className="lime-key-row lime-diacritics-row"),S.classList.add("lime-container-dim"),b.classList.add("lime-toggle"),i=S.getBoundingClientRect(),t=b.getBoundingClientRect(),o=b.parentNode.lastChild.getBoundingClientRect(),e.innerHTML="",Array.prototype.forEach.call(l,function(t){var i=e.appendChild(document.createElement("li"))
i.className="lime-key lime-diacritical",i.dataset.text=t}),S.appendChild(e),x=e,n=e.offsetWidth,e.style.left=e.style.right="",t.right+n<=o.right?e.style.left=t.right-i.left+"px":e.style.right=i.right-t.left+"px",e.style.top=t.top-i.top+"px",e.style.width=0,window.setTimeout(function(){e.style.width=n+"px"}))}function d(){x&&(x.parentNode.removeChild(x),S.classList.remove("lime-container-dim"),l(S.querySelector(".lime-toggle[data-text]")),b.classList.remove("lime-toggle"),L=b.getBoundingClientRect().left,x=null)}function u(){var e,t,i=document.activeElement,o=Array.prototype.slice.call((i.form||document).getElementsByTagName("*"))
for(o=o.filter(function(e){return e.tabIndex>-1&&e.offsetHeight&&!e.disabled}),o.sort(function(e,t){return(e.tabIndex||Number.MAX_VALUE)-(t.tabIndex||Number.MAX_VALUE)}),t=o.indexOf(i),o=o.slice(t+1).concat(o.slice(0,t)),t=0;document.activeElement!=e&&o.length;)e=o.shift(),e.focus()}function f(e){var t
return B?t=new CustomEvent(e,{bubbles:!0,cancelable:!0}):(t=document.createEvent("CustomEvent"),t.initCustomEvent(e,!0,!0)),document.activeElement.dispatchEvent(t)}function y(e){var t=/^(?:text|email|number|password|tel|url|search)$/
return(t.test(e.type)||e.isContentEditable)&&!e.readOnly}function g(e){var t=K.config.postInput
t&&t(e)}var p,v,b,h,w,k,E,L,C,x,T=document.createElement("style"),S=document.createElement("div"),K=e.keyLime||{config:{}},R=!1,B=function(){try{return!!new CustomEvent("a")}catch(e){return!1}}(),A=[".lime-container { background-color: #333; position: absolute; bottom: 0; left: 0; right: 0; color: #fff; z-index:1000000; font-family: sans-serif; }",'.lime-container-dim::before { position: absolute; content: ""; top: 0; left: 0; right: 0; bottom: 0; background-color: #000; opacity: 0.5; }',".lime-key-row { list-style-type: none; clear: both; text-align: center; padding: 0; margin: 0; font-size: 28px; }",".lime-diacritics-row { position: absolute; z-index: 2; overflow: hidden; -webkit-transition: width 400ms; transition: width 400ms; white-space: nowrap; }",".lime-key { vertical-align: top; display: inline-block; border: 3px solid #333; background-color: #666; width: 66px; line-height: 50px; -webkit-transition: all 400ms linear; transition: all 400ms linear; }",".lime-key[data-text]::before { content: attr(data-text) }",".lime-container.symbol-toggle .lime-key[data-symbol]::before { content: attr(data-symbol) }",".lime-container.shift-toggle .lime-key[data-text]:not(.lime-http):not(.lime-dotcom):not(.lime-wwwdot)::before { text-transform: uppercase; }",".lime-special-key { background-color: #999; color: #333; }",".lime-return { background-color: #ccc; width: 138px; }",".lime-focus { background-color: #26f; color: #fff; }",".lime-toggle { background-color: #2f2; color: #fff; position: relative; }",".lime-spacebar { width:498px; }",".lime-http, .lime-dotcom, .lime-wwwdot { font-size: 20px; }"],N=/^(?:text|search|url|tel|password)$/i,U=t(),D={Tab:u,Return:c,Shift:function(e){var t=S.querySelector(".lime-toggle")
t&&t.classList.remove("lime-toggle"),S.classList.remove("shift-toggle","symbol-toggle"),k=E=!1,h?(h=!1,w=!0,e.classList.add("lime-toggle")):w?w=!1:h=!0,(h||w)&&S.classList.add("shift-toggle")},Symbol:function(e){var t=S.querySelector(".lime-toggle")
t&&t.classList.remove("lime-toggle"),k=!k,h=w=E=!1,S.classList.remove("shift-toggle"),S.classList.toggle("symbol-toggle"),k&&e.classList.toggle("lime-toggle")},Backspace:function(){var e=document.activeElement,t=window.getSelection()
if(y(e))if(U||N.test(e.type)){var i=e.selectionStart
String(t).length?(e.value=e.value.slice(0,i)+e.value.slice(e.selectionEnd),e.selectionStart=i):(e.value=e.value.slice(0,i-1)+e.value.slice(i),e.selectionStart=i-1),g(e)}else String(t).length||t.modify("extend","backward","character"),t.deleteFromDocument()},Caret:function(e){var t=S.querySelector(".lime-toggle")
t&&t.classList.remove("lime-toggle"),k=h=w=!1,S.classList.remove("shift-toggle","symbol-toggle"),E=!E,E&&e.classList.add("lime-toggle")}},P={verbatim:{keys:{standard:[["@","1","2","3","4","5","6","7","8","9","0","-","="],["q","w","e","r","t","y","u","i","o","p","[","]"],["a","s","d","f","g","h","j","k","l",";","'"],["z","x","c","v","b","n","m",",",".","/"]],symbol:[["@","1","2","3","4","5","6","7","8","9","0","-","="],["~","#","`","£","$","%","^","&","(",")","[","]"],["•","€","¥","¡","¿","*","|","{","}",":","&quot;"],["_","+","!","\\","«","»","§","<",">","?"]]},diacritics:{a:"äáâàåæ",c:"ç©",d:"ð",e:"ëéêè",i:"ïíîì",m:"µ",n:"ñ",o:"öóôòõø",u:"üúûù",y:"ÿý"}}}
S.className="lime-container",S.lang="en",document.head.insertBefore(T,document.head.firstChild)
for(var q=0;q<A.length;q++)T.sheet.insertRule(A[q],q)
return document.addEventListener("focus",function(e){var t=e.target.tagName
if(K.config.noauto||!e.target.isContentEditable&&"INPUT"!==t&&"TEXTAREA"!==t||i(),R){S.style.top="",S.style.bottom=""
var o=e.target.getBoundingClientRect(),n=S.offsetTop,l=o.bottom-n
l>0&&(S.style.top="0",S.style.bottom="auto")}},!0),document.addEventListener("blur",function(){R&&!K.config.noauto&&o()},!0),document.addEventListener("keydown",function(e){if(R){var t=e.key.replace(/^Arrow/,"")
switch(t){case"Left":case"Right":case"Up":case"Down":if(E)return
s(e),a(t.toLowerCase())
break
case"Enter":b&&(p||(p=setTimeout(m,K.config.keyHoldTimeout||500)),s(e))
break
case"Escape":case"BrowserBack":s(e),E?D.Caret(b):x?d():o()}}},!0),document.addEventListener("keypress",function(e){if("password"!==e.target.type&&0!==e.charCode){var t=String.fromCharCode(e.keyCode).toLowerCase(),i=S.querySelector('li[data-text="'+t+'"]')
i&&(l(i),b=void 0,window.setTimeout(function(){i.classList.remove("lime-focus")},100))}},!0),document.addEventListener("keyup",function(e){if(R&&b)switch(e.key.replace(/^Arrow/,"")){case"Escape":case"BrowserBack":case"Up":case"Down":case"Left":case"Right":s(e)
break
case"Enter":s(e),clearTimeout(p),p=null,x&&!b.classList.contains("lime-diacritical")?l(x.firstChild):(r(),x&&d())}},!0),S.addEventListener("mousedown",function(e){s(e),e.target.classList.contains("lime-key")&&(p=setTimeout(m,K.config.keyHoldTimeout||500))},!0),S.addEventListener("mouseup",function(e){s(e),e.target.classList.contains("lime-key")&&(clearTimeout(p),p=null,r(),x&&d())},!0),S.addEventListener("mousemove",function(e){l(e.target)}),S.addEventListener("mouseout",function(e){b===e.target&&b.classList.remove("lime-focus")}),function(){var t={13:"Enter",27:"Escape",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown"},i={get:function(){var e=this.which
return t[e]||"Unidentified"}}
e.TvKeyCode?(t[TvKeyCode.RETURN]="BrowserBack",t[TvKeyCode.ENTER]="Enter",t[TvKeyCode.UP]="ArrowUp",t[TvKeyCode.DOWN]="ArrowDown",t[TvKeyCode.LEFT]="ArrowLeft",t[TvKeyCode.RIGHT]="ArrowRight"):e.KeyEvent&&e.KeyEvent.VK_ENTER&&(t[e.KeyEvent.VK_BACK]="BrowserBack",t[e.KeyEvent.VK_ENTER]="Enter"),e.KeyboardEvent&&!e.KeyboardEvent.prototype.hasOwnProperty("key")&&Object.defineProperty(e.KeyboardEvent.prototype,"key",i),e.KeyEvent&&e.KeyEvent.prototype&&!e.KeyEvent.prototype.hasOwnProperty("key")&&Object.defineProperty(e.KeyEvent.prototype,"key",i)}(e),n(),K.show=i,K.hide=o,K})
